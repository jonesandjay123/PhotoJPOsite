<!DOCTYPE html>

<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="aD3fKiDVrsnXJ8m47IC2qMrJxCGn4nHNl4LX-Hnoeb8" />
  <title>登入頁面</title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

  <link rel="stylesheet" href="main.css">

  <!-- Import and configure the Firebase SDK -->
  <!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
  <!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->

  <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
  <script src="init.js"></script>

  <script type="text/javascript">

	  //登出鈕
    function toggleSignIn() {
      if (firebase.auth().currentUser) {

        firebase.auth().signOut(); //執行登出

        window.location.href = "index.html"; //跳轉
      }
    }

    //寄送驗證碼
    function sendEmailVerification() {
      // [START sendemailverification]
      firebase.auth().currentUser.sendEmailVerification().then(function() {
        // Email Verification sent!
        // [START_EXCLUDE]
        alert('Email Verification Sent!');
        // [END_EXCLUDE]
      });
      // [END sendemailverification]
    }

    //上傳圖片
    function uploadFile()
    {



      //登入驗證
      firebase.auth().onAuthStateChanged(function(user) {

       if (user) {
         // User is signed in.
         var email = user.email;
         var uid = user.uid;


         var storageRef = firebase.storage().ref();

         var oFile = document.getElementById('file').files[0];
         if(oFile != null) {
           console.log("準備上傳: ");
           console.log(oFile);

           var sFilename = oFile.name;
           console.log(uid+"的 檔案名稱: "+sFilename);


           // File or Blob named mountains.jpg
           var file = oFile;

           // Create the file metadata
           var metadata = {
             contentType: 'image/jpeg'
           };

           // Upload file and metadata to the object 'images/mountains.jpg'
           var uploadTask = storageRef.child(uid + '/' + file.name).put(file, metadata);

           // Listen for state changes, errors, and completion of the upload.
           uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
             function(snapshot) {
               // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
               var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
               console.log('Upload is ' + progress + '% done');
               switch (snapshot.state) {
                 case firebase.storage.TaskState.PAUSED: // or 'paused'
                   console.log('Upload is paused');
                   break;
                 case firebase.storage.TaskState.RUNNING: // or 'running'
                   console.log('Upload is running');
                   break;
               }
             }, function(error) {

             // A full list of error codes is available at
             // https://firebase.google.com/docs/storage/web/handle-errors
             switch (error.code) {
               case 'storage/unauthorized':
                 // User doesn't have permission to access the object
                 break;
               case 'storage/canceled':
                 // User canceled the upload
                 break;
               case 'storage/unknown':
                 // Unknown error occurred, inspect error.serverResponse
                 break;
             }
           }, function() {
             // Upload completed successfully, now we can get the download URL
             uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
               console.log('File available at', downloadURL);
               alert("上傳成功!!");

                var img = document.getElementById('myimg');
                img.src = downloadURL;

                var inputObj = {
                  test: downloadURL,
                };

                firebase.database().ref("picture/"+uid).set(inputObj,function(error){
                  if(error){
                    alert(sFilename+"的資料寫入失敗!");
                    console.log(sFilename+"的資料寫入失敗! error: " + error);
                  }
                  else{
                    //alert(sFilename+" 資料寫入成功!");
                    console.log(sFilename+" 資料寫入成功!");
                  }
                });



             });
           });



         }
         else{
           alert("未選擇檔案~");
         }



       }
       else{
         alert("無法取得登入者資訊!");
       }

      });



    }

	   //初始化
    function initApp() {
      console.log("已登入homepage");

	     //登入驗證
      firebase.auth().onAuthStateChanged(function(user) {
        // [START_EXCLUDE silent]
        document.getElementById('quickstart-verify-email').disabled = true;
        // [END_EXCLUDE]
        if (user) {
          // User is signed in.
          var displayName = user.displayName;
          var email = user.email;
          var emailVerified = user.emailVerified;
          var photoURL = user.photoURL;
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;
          var providerData = user.providerData;

          document.getElementById('loginEmaildisplay').textContent = email;


          //元件初始化
          document.getElementById('quickstart-sign-in').textContent = 'Sign out';
          document.getElementById('quickstart-account-details').textContent = JSON.stringify(user, null, '  ');
          //console.log(user);

          if (!emailVerified) {
            document.getElementById('quickstart-verify-email').disabled = false;
          }
          //storage空間應用
    		  //var storageRef = firebase.storage().ref();

		  	 // storageRef.child('images/photoJPOicon.png').getDownloadURL().then(function(url) {
				 //  var img = document.getElementById('myimg');
				 //  img.src = url;
				 //    }).catch(function(error) {
				 //          alert("出錯!");
         //   });

    		  //讀取圖庫
    		  var scoresRef = firebase.database().ref("user");
    			scoresRef.orderByValue().on("value", function(snapshot) {
    			  snapshot.forEach(function(data) {
    				      console.log("人員名稱 " + data.key + ": ");
				          //console.log(data.val());
                  var parsedData = data.val();


                  for(var i in parsedData){
                    console.log(i + ":" + parsedData[i]); //alerts key's value
                  }

                  //console.log("parsedData.Age: "+parsedData.Age);
    			  });
    			});

          //圖片參考: http://photoswipe.com/

        }
        else
        {
          // User is signed out.
          // [START_EXCLUDE]
          document.getElementById('quickstart-sign-in').textContent = 'Sign in';
          document.getElementById('quickstart-account-details').textContent = 'null';

          //如果使用者是未登入的狀態，直接登出
	        window.location.href = "index.html";

        }
        document.getElementById('quickstart-sign-in').disabled = false;

    });


	  document.getElementById('quickstart-sign-in').addEventListener('click', toggleSignIn, false);
    document.getElementById('quickstart-verify-email').addEventListener('click', sendEmailVerification, false);

    }

    //初始化執行緒
    window.onload = function() {
      initApp();
    };
  </script>
</head>
<body>
<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

  <!-- Header section containing title -->
  <header class="mdl-layout__header mdl-color-text--white mdl-color--light-blue-700">
    <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
      <div class="mdl-layout__header-row mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--8-col-desktop">
        <a href="/"><h3>Firebase Authentication</h3></a>
      </div>
    </div>
  </header>

  <main class="mdl-layout__content mdl-color--grey-100">

	<button class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-in" name="signin">Sign Out</button>
  &nbsp;&nbsp;&nbsp;
  <button class="mdl-button mdl-js-button mdl-button--raised" disabled id="quickstart-verify-email" name="verify-email">Send Email Verification</button>

  <br>
  <span>登入者是: </span>
  <span id="loginEmaildisplay"></span>

  <div class="mdl-card__supporting-text mdl-color-text--grey-600" id="messagesDiv">
      <p>選擇要上傳的圖片</p>
      <h6>選取檔案:</h6>
      <input type="file" id="file" name="file" accept="image/x-png,image/gif,image/jpeg" />
      <button onclick="uploadFile()">上傳</button>
      <h6>File URL:</h6>
      <span id="linkbox"></span>
    </div>


	<img id="myimg" >

	<pre><code id="quickstart-account-details">null</code></pre>


  </main>
</div>
</body>
</html>
