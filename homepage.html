<!DOCTYPE html>

<html>

<style>
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
}

.header {
    text-align: center;
    padding: 32px;
}

.row {
    display: -ms-flexbox; /* IE 10 */
    display: flex;
    -ms-flex-wrap: wrap; /* IE 10 */
    flex-wrap: wrap;
    padding: 0 4px;
}

/* Create two equal columns that sits next to each other */
.column {
    -ms-flex: 50%; /* IE 10 */
    flex: 50%;
    padding: 0 4px;
}

.column img {
    margin-top: 8px;
    vertical-align: middle;
}

/* Style the buttons */
.btn {
    border: none;
    outline: none;
    padding: 10px 16px;
    background-color: #f1f1f1;
    cursor: pointer;
    font-size: 18px;
}

.btn:hover {
    background-color: #ddd;
}

.btn.active {
    background-color: #666;
    color: white;
}
</style>


<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="aD3fKiDVrsnXJ8m47IC2qMrJxCGn4nHNl4LX-Hnoeb8" />
  <title>登入頁面</title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

  <link rel="stylesheet" href="main.css">

  <!-- Import and configure the Firebase SDK -->
  <!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
  <!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->

  <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
  <script src="init.js"></script>

  <script type="text/javascript">

	  //登出鈕
    function toggleSignIn() {
      if (firebase.auth().currentUser) {

        firebase.auth().signOut(); //執行登出

        window.location.href = "email-password.html"; //跳轉
      }
    }

    //寄送驗證碼
    function sendEmailVerification() {
      // [START sendemailverification]
      firebase.auth().currentUser.sendEmailVerification().then(function() {
        // Email Verification sent!
        // [START_EXCLUDE]
        alert('Email Verification Sent!');
        // [END_EXCLUDE]
      });
      // [END sendemailverification]
    }

    //上傳圖片
    function uploadFile()
    {
      //登入驗證
      firebase.auth().onAuthStateChanged(function(user) {

       if (user) {
         // User is signed in.
         var uid = user.uid;

         var oFile = document.getElementById('file').files[0];
         if(oFile != null) {

           var sFilename = oFile.name;
           var sFileType = oFile.type;

           var d = new Date();
           var currentTime = d.getTime();

           //要上傳的檔案名稱為日期的long+uuidv4
           var uploadName = currentTime+uuidv4();

           // File or Blob named mountains.jpg
           var file = oFile;

           // Create the file metadata
           var metadata = {
             contentType: sFileType
           };

           var storageRef = firebase.storage().ref();

           // Upload file and metadata to the object 'images/mountains.jpg'
           var uploadTask = storageRef.child(uid + '/' + uploadName).put(file, metadata);

           // Listen for state changes, errors, and completion of the upload.
           uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
             function(snapshot) {
               // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
               var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
               console.log('Upload is ' + progress + '% done');
               switch (snapshot.state) {
                 case firebase.storage.TaskState.PAUSED: // or 'paused'
                   console.log('Upload is paused');
                   break;
                 case firebase.storage.TaskState.RUNNING: // or 'running'
                   console.log('Upload is running');
                   break;
               }
             }, function(error) {

             // A full list of error codes is available at
             // https://firebase.google.com/docs/storage/web/handle-errors
             switch (error.code) {
               case 'storage/unauthorized':
                 // User doesn't have permission to access the object
                 break;
               case 'storage/canceled':
                 // User canceled the upload
                 break;
               case 'storage/unknown':
                 // Unknown error occurred, inspect error.serverResponse
                 break;
             }
           }, function() {
             // Upload completed successfully, now we can get the download URL
             uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {

                console.log("剛剛上傳的圖片的url: "+downloadURL);

                console.log(uploadTask.snapshot);
                console.log(uploadTask.snapshot.metadata);

                var pid = uploadTask.snapshot.metadata.name; //拿metadata.name當pid
                var d = new Date();
                var currentTime = d.getTime();

                var inputObj = {
                  pid : pid,
                  access: true,
                  name : sFilename,
                  fileType: sFileType,
                  uploadtime : currentTime,
                  url : downloadURL
                };
                firebase.database().ref("images/"+pid).set(inputObj,function(error){
                  if(error){
                    alert(sFilename+"的資料寫入失敗!");
                    console.log(sFilename+"的資料寫入失敗! error: " + error);
                  }
                  else{
                    console.log(sFilename+" 資料寫入成功!");
                  }
                });

                //要自己拿pid生成key值的做法如下:
                var picture = pid;
                var inputObj2 = {};
                inputObj2[picture] = downloadURL;

                //userImg的資料結構，必須使用update(而非set)，否則會蓋掉上一筆的紀錄!!
                firebase.database().ref("userImg/"+uid).update(inputObj2,function(error){
                  if(error){
                    alert(sFilename+"的資料寫入失敗!");
                    console.log(sFilename+"的資料寫入失敗! error: " + error);
                  }
                  else{
                    console.log(sFilename+" 資料寫入成功!");
                  }
                });

               alert("圖片上傳成功!!");

             });
           });



         }
         else{
           alert("未選擇檔案~");
         }



       }
       else{
         alert("無法取得登入者資訊!");
       }

      });



    }

	   //初始化
    function initApp() {
      console.log("已登入homepage");

	     //登入驗證
      firebase.auth().onAuthStateChanged(function(user) {
        // [START_EXCLUDE silent]
        document.getElementById('quickstart-verify-email').disabled = true;
        // [END_EXCLUDE]
        if (user) {
          // User is signed in.
          var displayName = user.displayName;
          var email = user.email;
          var emailVerified = user.emailVerified;
          var photoURL = user.photoURL;
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;
          var providerData = user.providerData;

          document.getElementById('loginEmaildisplay').textContent = email;

          //元件初始化
          document.getElementById('quickstart-sign-in').textContent = 'Sign out';
//document.getElementById('quickstart-account-details').textContent = JSON.stringify(user, null, '  ');

          if (!emailVerified) {
            document.getElementById('quickstart-verify-email').disabled = false;
          }

         console.log("登入者的uid: "+uid);

         //在userImg中讀取屬於uid的圖片
         const userImgs = firebase.database().ref("userImg/"+uid);

         userImgs.on("value", snapshot =>{

           var imgGrid = document.getElementById("imageGrid");  //table清單
           //每次繪製前，都要先把imgGrid過去的內容清空
           imgGrid.innerHTML = "";

           var srnWidth = window.innerWidth; //螢幕寬度
           var widthStandard = (srnWidth/4) -20 ;   //用螢幕寬度/4為基準
           console.log("圖片顯示寬度的最大允許值為: "+widthStandard);

           snapshot.forEach(function(data) {
                 //console.log("圖片pid: " + data.key + ": "+data.val());
                 var dv = document.createElement("div");
                 dv.className = "column";
                 var img = document.createElement("img");
                 img.src = data.val();
                 img.onload = function(){
                     if(this.width>widthStandard){
                       this.width = widthStandard;
                     }
                 };
                 dv.appendChild(img);
                 imgGrid.appendChild(dv);
           });
         });

        }
        else
        {
          // User is signed out.
          // [START_EXCLUDE]
          document.getElementById('quickstart-sign-in').textContent = 'Sign in';
          //document.getElementById('quickstart-account-details').textContent = 'null';

          //如果使用者是未登入的狀態，直接登出
	        window.location.href = "email-password.html";

        }
        document.getElementById('quickstart-sign-in').disabled = false;

    });


	  document.getElementById('quickstart-sign-in').addEventListener('click', toggleSignIn, false);
    document.getElementById('quickstart-verify-email').addEventListener('click', sendEmailVerification, false);

    }

    //生成uid的方法
    function uuidv4() {
      return 'xxxxxxxx'.replace(/[xy]/g, function(c) {
      //return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    //初始化執行緒
    window.onload = function() {
      initApp();
    };
  </script>
</head>
<body>
<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

  <!-- Header section containing title -->
  <header class="mdl-layout__header mdl-color-text--white mdl-color--light-blue-700">
    <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
      <div class="mdl-layout__header-row mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--8-col-desktop">
        <a href="/"><h3>Firebase Authentication</h3></a>
      </div>
    </div>
  </header>

  <main class="mdl-layout__content mdl-color--grey-100">

	<button class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-in" name="signin">Sign Out</button>
  &nbsp;&nbsp;&nbsp;
  <button class="mdl-button mdl-js-button mdl-button--raised" disabled id="quickstart-verify-email" name="verify-email">Send Email Verification</button>

  <br>
  <span>登入者是: </span>
  <span id="loginEmaildisplay"></span>

  <div class="mdl-card__supporting-text mdl-color-text--grey-600" id="messagesDiv">
      <p>選擇要上傳的圖片</p>
      <h6>選取檔案:</h6>
      <input type="file" id="file" name="file" accept="image/x-png,image/gif,image/jpeg" />
      <button onclick="uploadFile()">上傳</button>
      <h6>File URL:</h6>
      <span id="linkbox"></span>
    </div>

    <!-- Header -->
    <div class="header" id="myHeader">
      <h1>Image Grid</h1>
      <p>Click on the buttons to change the grid view.</p>
      <button class="btn" onclick="one()">1</button>
      <button class="btn active" onclick="two()">2</button>
      <button class="btn" onclick="four()">4</button>
      <button class="btn" onclick="Six()">6</button>
    </div>

  <div class="row" id="imageGrid"></div>



	<!-- <pre><code id="quickstart-account-details">null</code></pre> -->


  </main>
</div>


<script>
// 參考W3school的ImageGrid
//https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_image_grid
var elements = document.getElementsByClassName("column");

// Declare a loop variable
var i;

// Full-width images
function one() {
    for (i = 0; i < elements.length; i++) {
        elements[i].style.msFlex = "100%";  // IE10
        elements[i].style.flex = "100%";
    }
}

// Two images side by side
function two() {
    for (i = 0; i < elements.length; i++) {
        elements[i].style.msFlex = "50%";  // IE10
        elements[i].style.flex = "50%";
    }
}

// Four images side by side
function four() {
    for (i = 0; i < elements.length; i++) {
        elements[i].style.msFlex = "25%";  // IE10
        elements[i].style.flex = "25%";
    }
}

// Six images side by side
function Six() {
    for (i = 0; i < elements.length; i++) {
        elements[i].style.msFlex = "16.6%";  // IE10
        elements[i].style.flex = "16.6%";
    }
}

// Add active class to the current button (highlight it)
var header = document.getElementById("myHeader");
var btns = header.getElementsByClassName("btn");
for (var i = 0; i < btns.length; i++) {
  btns[i].addEventListener("click", function() {
    var current = document.getElementsByClassName("active");
    current[0].className = current[0].className.replace(" active", "");
    this.className += " active";
  });
}
</script>


</body>
</html>
